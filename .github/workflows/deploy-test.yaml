name: deploy-test

on:
  push:
    branches:
    - "*"  # run for branches

jobs:
  #
  #
  #check complete demo is in sync with individual manifest, it should block fom merge. Should this be a diferent file?
  complete-demo-sync-check:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2
      
      # - name: Wait cluster to start
      #   run: |
      #     until [ "$(kubectl get pods -A --no-headers | grep -cEv '([0-9]+)/\1')" -eq 0 ]; do
      #         sleep 5s
      #     done
      #     kubectl get pod -A
      - name: Run and test Complete demo
        run: |
          kubectl apply -f deploy/kubernetes/complete-demo.yaml
          until [ "$(kubectl get pods -n sock-shop --no-headers | grep -cEv '([0-9]+)/\1')" -eq 0 ]; do
              sleep 5s
              kubectl get pods -n sock-shop
              kubectl describe node | grep "Allocated resources" -A 10
          done
          kubectl get pod -A